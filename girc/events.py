#!/usr/bin/env python3
# Written by Daniel Oaks <daniel@danieloaks.net>
# Released under the ISC license
from .utils import NickMask


def message_to_event(direction, message):
    """Prepare an ``RFC1459Message`` for event dispatch.

    We do this because we have to handle special things as well.
    """
    server = message.server

    # change numerics into nice names
    if message.verb in numerics:
        message.verb = numerics[message.verb]

    # differentiate between private and public messages
    verb = message.verb.lower()
    if verb == 'privmsg':
        if server.is_channel(message.params[0]):
            verb = 'pubmsg'

    # this is the same as ircreactor does
    info = message.__dict__
    info['direction'] = direction
    info['verb'] = verb

    # custom message attributes
    if verb in ['privmsg', 'pubmsg']:
        info['target'] = info['params'][0]
        info['message'] = info['params'][1]

    for attr in ['source', 'target']:
        if attr in info and info[attr]:
            source = info[attr]
            if server.is_nick(source):
                server.info.create_user(source)
                info[attr] = server.info.users[NickMask(source).nick]
            elif server.is_channel(source):
                server.info.create_channel(source)
                info[attr] = server.info.channels[source]

    return verb, info


# list adapted from https://www.alien.net.au/irc/irc2numerics.html
# probably insane stuff in here, and stuff that's not implemented in anything really
numerics = {
    '001': 'welcome',
    '002': 'yourhost',
    '003': 'created',
    '004': 'myinfo',
    '005': 'features',
    '008': 'snomask',
    '009': 'statmemtot',
    '010': 'bounce',
    '014': 'yourcookie',
    '042': 'yourid',
    '043': 'savenick',
    '050': 'attemptingjunc',
    '051': 'attemptingreroute',
    '200': 'tracelink',
    '201': 'traceconnecting',
    '202': 'tracehandshake',
    '203': 'traceunknown',
    '204': 'traceoperator',
    '205': 'traceuser',
    '206': 'traceserver',
    '207': 'traceservice',
    '208': 'tracenewtype',
    '209': 'traceclass',
    '210': 'stats',
    '211': 'statslinkinfo',
    '212': 'statscommands',
    '213': 'statscline',
    '215': 'statsiline',
    '216': 'statskline',
    '218': 'statsyline',
    '219': 'endofstats',
    '221': 'umodeis',
    '234': 'servlist',
    '235': 'servlistend',
    '236': 'statsverbose',
    '237': 'statsengine',
    '239': 'statsiauth',
    '241': 'statslline',
    '242': 'statsuptime',
    '243': 'statsoline',
    '244': 'statshline',
    '245': 'statssline',
    '250': 'statsconn',
    '251': 'luserclient',
    '252': 'luserop',
    '253': 'luserunknown',
    '254': 'luserchannels',
    '255': 'luserme',
    '256': 'adminme',
    '257': 'adminloc1',
    '258': 'adminloc2',
    '259': 'adminemail',
    '261': 'tracelog',
    '263': 'tryagain',
    '265': 'localusers',
    '266': 'globalusers',
    '267': 'start_netstat',
    '268': 'netstat',
    '269': 'end_netstat',
    '270': 'privs',
    '271': 'silelist',
    '272': 'endofsilelist',
    '273': 'notify',
    '276': 'vchanexist',
    '277': 'vchanlist',
    '278': 'vchanhelp',
    '280': 'glist',
    '296': 'chaninfo_kicks',
    '299': 'end_chaninfo',
    '300': 'none',
    '301': 'away',
    '302': 'userhost',
    '303': 'ison',
    '305': 'unaway',
    '306': 'nowaway',
    '311': 'whoisuser',
    '312': 'whoisserver',
    '313': 'whoisoperator',
    '314': 'whowasuser',
    '315': 'endofwho',
    '317': 'whoisidle',
    '318': 'endofwhois',
    '319': 'whoischannels',
    '320': 'whoisspecial',
    '322': 'list',
    '323': 'listend',
    '324': 'channelmodeis',
    '326': 'nochanpass',
    '327': 'chpassunknown',
    '328': 'channel_url',
    '329': 'creationtime',
    '331': 'notopic',
    '332': 'topic',
    '333': 'topicwhotime',
    '339': 'badchanpass',
    '340': 'userip',
    '341': 'inviting',
    '345': 'invited',
    '346': 'invitelist',
    '347': 'endofinvitelist',
    '348': 'exceptlist',
    '349': 'endofexceptlist',
    '351': 'version',
    '352': 'whoreply',
    '353': 'namreply',
    '354': 'whospcrpl',
    '355': 'namreply_',
    '364': 'links',
    '365': 'endoflinks',
    '366': 'endofnames',
    '367': 'banlist',
    '368': 'endofbanlist',
    '369': 'endofwhowas',
    '371': 'info',
    '372': 'motd',
    '374': 'endofinfo',
    '375': 'motdstart',
    '376': 'endofmotd',
    '381': 'youreoper',
    '382': 'rehashing',
    '383': 'youreservice',
    '385': 'notoperanymore',
    '388': 'alist',
    '389': 'endofalist',
    '391': 'time',
    '392': 'usersstart',
    '393': 'users',
    '394': 'endofusers',
    '395': 'nousers',
    '396': 'hosthidden',
    '400': 'unknownerror',
    '401': 'nosuchnick',
    '402': 'nosuchserver',
    '403': 'nosuchchannel',
    '404': 'cannotsendtochan',
    '405': 'toomanychannels',
    '406': 'wasnosuchnick',
    '407': 'toomanytargets',
    '408': 'nosuchservice',
    '409': 'noorigin',
    '410': 'invalidcapcmd',
    '411': 'norecipient',
    '412': 'notexttosend',
    '413': 'notoplevel',
    '414': 'wildtoplevel',
    '415': 'badmask',
    '416': 'querytoolong',
    '419': 'lengthtruncated',
    '421': 'unknowncommand',
    '422': 'nomotd',
    '423': 'noadmininfo',
    '424': 'fileerror',
    '425': 'noopermotd',
    '429': 'toomanyaway',
    '430': 'eventnickchange',
    '431': 'nonicknamegiven',
    '432': 'erroneusnickname',
    '433': 'nicknameinuse',
    '436': 'nickcollision',
    '439': 'targettoofast',
    '440': 'servicesdown',
    '441': 'usernotinchannel',
    '442': 'notonchannel',
    '443': 'useronchannel',
    '444': 'nologin',
    '445': 'summondisabled',
    '446': 'usersdisabled',
    '447': 'nonickchange',
    '449': 'notimplemented',
    '451': 'notregistered',
    '452': 'idcollision',
    '453': 'nicklost',
    '455': 'hostilename',
    '456': 'acceptfull',
    '457': 'acceptexist',
    '458': 'acceptnot',
    '459': 'nohiding',
    '460': 'notforhalfops',
    '461': 'needmoreparams',
    '462': 'alreadyregistered',
    '463': 'nopermforhost',
    '464': 'passwdmismatch',
    '465': 'yourebannedcreep',
    '467': 'keyset',
    '469': 'linkset',
    '471': 'channelisfull',
    '472': 'unknownmode',
    '473': 'inviteonlychan',
    '474': 'bannedfromchan',
    '475': 'badchannelkey',
    '476': 'badchanmask',
    '478': 'banlistfull',
    '479': 'linkfail',
    '481': 'noprivileges',
    '482': 'chanoprivsneeded',
    '483': 'cantkillserver',
    '485': 'uniqoprivsneeded',
    '488': 'tslesschan',
    '491': 'nooperhost',
    '493': 'nofeature',
    '494': 'badfeature',
    '495': 'badlogtype',
    '496': 'badlogsys',
    '497': 'badlogvalue',
    '498': 'isoperlchan',
    '499': 'chanownprivneeded',
    '501': 'umodeunknownflag',
    '502': 'usersdontmatch',
    '503': 'ghostedclient',
    '504': 'usernotonserv',
    '511': 'silelistfull',
    '512': 'toomanywatch',
    '513': 'badping',
    '515': 'badexpire',
    '516': 'dontcheat',
    '517': 'disabled',
    '522': 'whosyntax',
    '523': 'wholimexceed',
    '525': 'remotepfx',
    '526': 'pfxunroutable',
    '550': 'badhostmask',
    '551': 'hostunavail',
    '552': 'usingsline',
    '600': 'logon',
    '601': 'logoff',
    '602': 'watchoff',
    '603': 'watchstat',
    '604': 'nowon',
    '605': 'nowoff',
    '606': 'watchlist',
    '607': 'endofwatchlist',
    '608': 'watchclear',
    '611': 'islocop',
    '612': 'isnotoper',
    '613': 'endofisoper',
    '618': 'dcclist',
    '624': 'omotdstart',
    '625': 'omotd',
    '626': 'endofo',
    '630': 'settings',
    '631': 'endofsettings',
    '660': 'traceroute_hop',
    '661': 'traceroute_start',
    '662': 'modechangewarn',
    '663': 'chanredir',
    '664': 'servmodeis',
    '665': 'otherumodeis',
    '666': 'endof_generic',
    '670': 'starttls',
    # '670': 'whowasdetails',
    '671': 'whoissecure',
    '672': 'unknownmodes',
    '673': 'cannotsetmodes',
    '678': 'luserstaff',
    '679': 'timeonserveris',
    '682': 'networks',
    '687': 'yourlanguageis',
    '688': 'language',
    '689': 'whoisstaff',
    '690': 'whoislanguage',
    '691': 'starttls_error',
    '702': 'modlist',
    '703': 'endofmodlist',
    '704': 'helpstart',
    '705': 'helptxt',
    '706': 'endofhelp',
    '708': 'etracefull',
    '709': 'etrace',
    '710': 'knock',
    '711': 'knockdlvr',
    '712': 'toomanyknock',
    '713': 'chanopen',
    '714': 'knockonchan',
    '715': 'knockdisabled',
    '716': 'targumodeg',
    '717': 'targnotify',
    '718': 'umodegmsg',
    '720': 'omotdstart',
    '721': 'omotd',
    '722': 'endofomotd',
    '723': 'noprivs',
    '724': 'testmark',
    '725': 'testline',
    '726': 'notestline',
    '730': 'mononline',
    '731': 'monoffline',
    '732': 'monlist',
    '733': 'endofmonlist',
    '734': 'monlistfull',
    '760': 'whoiskeyvalue',
    '761': 'keyvalue',
    '762': 'metadataend',
    '764': 'metadatalimit',
    '765': 'targetinvalid',
    '766': 'nomatchingkey',
    '767': 'keyinvalid',
    '768': 'keynotset',
    '769': 'keynopermission',
    '771': 'xinfo',
    '773': 'xinfostart',
    '774': 'xinfoend',
    '900': 'loggedin',
    '901': 'loggedout',
    '902': 'nicklocked',
    '903': 'saslsuccess',
    '904': 'saslfail',
    '905': 'sasltoolong',
    '906': 'saslaborted',
    '907': 'saslalready',
    '908': 'saslmechs',
    '972': 'cannotdocommand',
    '973': 'cannotchangeumode',
    '974': 'cannotchangechanmode',
    '975': 'cannotchangeservermode',
    '976': 'cannotsendtonick',
    '977': 'unknownservermode',
    '979': 'servermodelock',
    '980': 'badcharencoding',
    '981': 'toomanylanguages',
    '982': 'nolanguage',
    '983': 'texttooshort',
    '999': 'numeric_error',
}
